<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FQS Queue Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #000000;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #fafafa;
            --surface: #ffffff99;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: var(--text-secondary);
            font-weight: 400;
            font-size: 1.1rem;
        }

        .queues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .queue-column {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .queue-column:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .queued { border-top: 4px solid var(--primary); }
        .started { border-top: 4px solid var(--primary); }
        .done { border-top: 4px solid var(--primary); }

        .queue-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .queue-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .queue-count {
            background: var(--background);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .queued .queue-count { color: var(--primary); background: rgba(245, 158, 11, 1); }
        .started .queue-count { color: var(--primary); background: rgba(99, 102, 241, 1); }
        .done .queue-count { color: var(--primary); background: rgba(16, 185, 129, 1); }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 500px;
        }

        .queue-item {
            background: var(--background);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            font-size: 2em;
            font-weight: 1000;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .queue-item:hover {
            transform: scale(1.02);
            border-color: var(--border);
        }

        .queued-item { 
            color: var(--primary);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 1), rgba(245, 158, 11, 1));
        }
        
        .started-item { 
            color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 1), rgba(99, 102, 241, 1));
        }
        
        .done-item { 
            color: var(--primary);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 1), rgba(16, 185, 129, 1));
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            font-style: italic;
        }

        .status-dot {
            position: fixed;
            top: 24px;
            right: 24px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--surface);
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.disconnected { background: var(--danger); }
        .status-dot.connecting { 
            background: var(--warning);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connection-status {
            position: fixed;
            top: 40px;
            right: 24px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .status-dot:hover + .connection-status {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .queues-grid {
                grid-template-columns: 1fr;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .queue-column {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .app-title {
                font-size: 1.8rem;
            }
            
            .queue-title {
                font-size: 1.1rem;
            }
            
            .queue-item {
                font-size: 1.2rem;
                padding: 14px;
            }
        }
    </style>
</head>
<body style="background-image: url('bg.jpg'); background-repeat: no-repeat; background-size: cover;">
    <div class="container">

        <div class="queues-grid">
            <div class="queue-column queued">
                <div class="queue-header">
                    <h2 class="queue-title">Queued</h2>
                    <span class="queue-count" id="queuedCount">0</span>
                </div>
                <div id="queuedList" class="queue-list">
                    <div class="empty-state">No items in queue</div>
                </div>
            </div>
            
            <div class="queue-column started">
                <div class="queue-header">
                    <h2 class="queue-title">Preparing</h2>
                    <span class="queue-count" id="startedCount">0</span>
                </div>
                <div id="startedList" class="queue-list">
                    <div class="empty-state">No active orders</div>
                </div>
            </div>
            
            <div class="queue-column done">
                <div class="queue-header">
                    <h2 class="queue-title">Please Collect</h2>
                    <span class="queue-count" id="doneCount">0</span>
                </div>
                <div id="doneList" class="queue-list">
                    <div class="empty-state">No completed orders</div>
                </div>
            </div>
        </div>
    </div>

    <div id="connectionStatus" class="status-dot"></div>
    <div class="connection-status">Connection status</div>

    <script>
        class QueueMonitor {
            constructor() {
                this.queuedList = [];
                this.startedList = [];
                this.doneList = [];
                this.hubConnection = null;
                
                this.initializeSignalR();
                this.getActiveQueue();
            }

            async initializeSignalR() {
                this.hubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("https://fqsapi.onrender.com/queueHub")
                    .withAutomaticReconnect()
                    .build();

                this.hubConnection.on("ReceiveQueueCode", (receivedData) => {
                    console.log("Received:", receivedData);
                    const [queueCodeStr, statusStr] = receivedData.split(':');
                    const queueCode = parseInt(queueCodeStr);
                    const status = parseInt(statusStr);
                    
                    this.updateQueueLists(queueCode, status);
                    this.renderAllQueues();
                });

                try {
                    await this.hubConnection.start();
                    this.updateConnectionStatus("connected");
                    console.log("SignalR connected");
                } catch (ex) {
                    this.updateConnectionStatus("disconnected");
                    console.error("SignalR connection failed:", ex);
                }

                this.hubConnection.onreconnecting(() => {
                    this.updateConnectionStatus("connecting");
                });

                this.hubConnection.onreconnected(() => {
                    this.updateConnectionStatus("connected");
                });
            }

            async getActiveQueue() {
                try {
                    const response = await axios.post(
                        "https://fqsapi.onrender.com/FireBaseFQS/GetActiveQueue",
                        null,
                        {
                            headers: { 'Content-Type': 'application/json' },
                            timeout: 10000
                        }
                    );

                    const activeQueue = response.data;
                    
                    this.queuedList = [];
                    this.startedList = [];
                    this.doneList = [];

                    if (activeQueue.queued) {
                        this.queuedList = activeQueue.queued.map(code => ({ qCode: code }));
                    }
                    if (activeQueue.inProgress) {
                        this.startedList = activeQueue.inProgress.map(code => ({ qCode: code }));
                    }
                    if (activeQueue.completed) {
                        this.doneList = activeQueue.completed.map(code => ({ qCode: code }));
                    }

                    this.renderAllQueues();
                    
                } catch (error) {
                    console.error("Failed to get active queue:", error);
                }
            }

            updateQueueLists(queueCode, status) {
                const item = { qCode: queueCode };
                
                switch (status) {
                    case 1: // Queued
                        if (!this.queuedList.some(x => x.qCode === queueCode)) {
                            this.queuedList.push(item);
                        }
                        break;
                    case 2: // Started
                        this.queuedList = this.queuedList.filter(x => x.qCode !== queueCode);
                        if (!this.startedList.some(x => x.qCode === queueCode)) {
                            this.startedList.push(item);
                        }
                        break;
                    case 3: // Done
                        this.startedList = this.startedList.filter(x => x.qCode !== queueCode);
                        if (!this.doneList.some(x => x.qCode === queueCode)) {
                            this.doneList.push(item);
                        }
                        break;
                    case 4: // Remove
                        this.doneList = this.doneList.filter(x => x.qCode !== queueCode);
                        break;
                }
            }

            renderAllQueues() {
                this.renderQueue(this.queuedList, "queuedList", "queued-item", "queuedCount");
                this.renderQueue(this.startedList, "startedList", "started-item", "startedCount");
                this.renderQueue(this.doneList, "doneList", "done-item", "doneCount");
            }

            renderQueue(queueArray, elementId, itemClass, countElementId) {
                const element = document.getElementById(elementId);
                const countElement = document.getElementById(countElementId);
                
                countElement.textContent = queueArray.length;
                
                if (queueArray.length === 0) {
                    element.innerHTML = '<div class="empty-state">No items</div>';
                    return;
                }
                
                element.innerHTML = queueArray.map(item => 
                    `<div class="queue-item ${itemClass}">${item.qCode}</div>`
                ).join('');
            }

            updateConnectionStatus(status) {
                const statusElement = document.getElementById("connectionStatus");
                statusElement.className = `status-dot ${status}`;
                
                // Update tooltip text
                const statusText = document.querySelector('.connection-status');
                statusText.textContent = status === 'connected' ? 'Connected to server' :
                                      status === 'connecting' ? 'Connecting...' : 'Disconnected';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new QueueMonitor();
        });
    </script>
</body>
</html>
