<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FQS Queue Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .queues-container {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .queue-column {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 250px;
        }
        .queue-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .queued { border-top: 4px solid #ff6b6b; }
        .started { border-top: 4px solid #4ecdc4; }
        .done { border-top: 4px solid #45b7d1; }
        
        .queue-list {
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }
        .queue-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .queued-item { background: #ffeaea; border-left: 4px solid #ff6b6b; }
        .started-item { background: #e0f4f2; border-left: 4px solid #4ecdc4; }
        .done-item { background: #e3f2fd; border-left: 4px solid #45b7d1; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FQS Queue Monitor</h1>
            <div id="connectionStatus" class="status">Connecting to SignalR...</div>
        </div>

        <div class="queues-container">
            <div class="queue-column queued">
                <div class="queue-title">Queued</div>
                <div id="queuedList" class="queue-list"></div>
            </div>
            
            <div class="queue-column started">
                <div class="queue-title">Started</div>
                <div id="startedList" class="queue-list"></div>
            </div>
            
            <div class="queue-column done">
                <div class="queue-title">Done</div>
                <div id="doneList" class="queue-list"></div>
            </div>
        </div>
    </div>

    <script>
        class QueueMonitor {
            constructor() {
                this.queuedList = [];
                this.startedList = [];
                this.doneList = [];
                this.hubConnection = null;
                
                this.initializeSignalR();
                this.getActiveQueue();
            }

            async initializeSignalR() {
                // Create connection to SignalR hub
                this.hubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("https://fqsapi.onrender.com/queueHub")
                    .withAutomaticReconnect()
                    .build();

                // Handle received queue codes
                this.hubConnection.on("ReceiveQueueCode", (receivedData) => {
                    console.log("Received:", receivedData);
                    const [queueCodeStr, statusStr] = receivedData.split(':');
                    const queueCode = parseInt(queueCodeStr);
                    const status = parseInt(statusStr);
                    
                    this.updateQueueLists(queueCode, status);
                    this.renderAllQueues();
                });

                try {
                    await this.hubConnection.start();
                    this.updateConnectionStatus("Connected to queue hub!", "connected");
                    console.log("SignalR connected");
                } catch (ex) {
                    this.updateConnectionStatus(`Connection failed: ${ex.message}`, "disconnected");
                    console.error("SignalR connection failed:", ex);
                }
            }

            async getActiveQueue() {
                try {
                    const response = await axios.post(
                        "https://fqsapi.onrender.com/FireBaseFQS/GetActiveQueue",
                        null,
                        {
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            timeout: 10000
                        }
                    );

                    const activeQueue = response.data;
                    
                    // Clear existing lists
                    this.queuedList = [];
                    this.startedList = [];
                    this.doneList = [];

                    // Populate queues from API response
                    if (activeQueue.queued) {
                        this.queuedList = activeQueue.queued.map(code => ({ qCode: code }));
                    }
                    if (activeQueue.inProgress) {
                        this.startedList = activeQueue.inProgress.map(code => ({ qCode: code }));
                    }
                    if (activeQueue.completed) {
                        this.doneList = activeQueue.completed.map(code => ({ qCode: code }));
                    }

                    this.renderAllQueues();
                    
                } catch (error) {
                    console.error("Failed to get active queue:", error);
                }
            }

            updateQueueLists(queueCode, status) {
                const item = { qCode: queueCode };
                
                switch (status) {
                    case 1: // Queued
                        if (!this.queuedList.some(x => x.qCode === queueCode)) {
                            this.queuedList.push(item);
                        }
                        break;
                    case 2: // Started
                        this.queuedList = this.queuedList.filter(x => x.qCode !== queueCode);
                        if (!this.startedList.some(x => x.qCode === queueCode)) {
                            this.startedList.push(item);
                        }
                        break;
                    case 3: // Done
                        this.startedList = this.startedList.filter(x => x.qCode !== queueCode);
                        if (!this.doneList.some(x => x.qCode === queueCode)) {
                            this.doneList.push(item);
                        }
                        break;
                    case 4: // Remove
                        this.doneList = this.doneList.filter(x => x.qCode !== queueCode);
                        break;
                }
            }

            renderAllQueues() {
                this.renderQueue(this.queuedList, "queuedList", "queued-item");
                this.renderQueue(this.startedList, "startedList", "started-item");
                this.renderQueue(this.doneList, "doneList", "done-item");
            }

            renderQueue(queueArray, elementId, itemClass) {
                const element = document.getElementById(elementId);
                if (queueArray.length === 0) {
                    element.innerHTML = '<div class="queue-item">No items</div>';
                    return;
                }
                
                element.innerHTML = queueArray.map(item => 
                    `<div class="queue-item ${itemClass}">${item.qCode}</div>`
                ).join('');
            }

            updateConnectionStatus(message, statusClass) {
                const statusElement = document.getElementById("connectionStatus");
                statusElement.textContent = message;
                statusElement.className = `status ${statusClass}`;
            }
        }

        // Initialize the queue monitor when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new QueueMonitor();
        });
    </script>
</body>
</html>
