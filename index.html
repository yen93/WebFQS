<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FQS Queue Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 20px; }
    .column { display: inline-block; vertical-align: top; margin-right: 30px; }
    ul { list-style: none; padding: 0; background: #f5f5f5; min-width: 120px; min-height: 150px; border-radius: 8px; padding: 10px; }
    li { padding: 6px; margin: 4px 0; background: white; border-radius: 4px; text-align: center; }
  </style>
</head>
<body>
  <h1>Queue Monitor</h1>

  <div class="column">
    <h2>Queued</h2>
    <ul id="queued"></ul>
  </div>

  <div class="column">
    <h2>Started</h2>
    <ul id="started"></ul>
  </div>

  <div class="column">
    <h2>Done</h2>
    <ul id="done"></ul>
  </div>

  <script>
    const queuedList = document.getElementById("queued");
    const startedList = document.getElementById("started");
    const doneList = document.getElementById("done");

    let queued = [];
    let started = [];
    let done = [];

    // Render lists
    function render() {
      queuedList.innerHTML = queued.map(q => `<li>${q}</li>`).join("");
      startedList.innerHTML = started.map(s => `<li>${s}</li>`).join("");
      doneList.innerHTML = done.map(d => `<li>${d}</li>`).join("");
    }

    // Fetch initial queue from API
    async function fetchQueue() {
      try {
        const res = await axios.post("https://fqsapi.onrender.com/FireBaseFQS/GetActiveQueue", null, {
          headers: { "Content-Type": "application/json" }
        });
        queued = res.data.queued || [];
        started = res.data.inProgress || [];
        done = res.data.completed || [];
        render();
      } catch (err) {
        console.error("Failed to load queue:", err);
      }
    }

    // Connect to SignalR hub
    const connection = new signalR.HubConnectionBuilder()
      .withUrl("https://fqsapi.onrender.com/queueHub")
      .withAutomaticReconnect()
      .build();

    connection.on("ReceiveQueueCode", (receivedData) => {
      console.log("SignalR message:", receivedData);
      const [codeStr, statusStr] = receivedData.split(":");
      const code = parseInt(codeStr);
      const status = parseInt(statusStr);

      // Update local lists
      if (status === 1) {
        if (!queued.includes(code)) queued.push(code);
      } else if (status === 2) {
        queued = queued.filter(x => x !== code);
        if (!started.includes(code)) started.push(code);
      } else if (status === 3) {
        started = started.filter(x => x !== code);
        if (!done.includes(code)) done.push(code);
      } else if (status === 4) {
        done = done.filter(x => x !== code);
      }

      render();
    });

    async function startConnection() {
      try {
        await connection.start();
        console.log("Connected to SignalR hub!");
      } catch (err) {
        console.error("SignalR connection failed:", err);
        setTimeout(startConnection, 5000); // retry
      }
    }

    fetchQueue();
    startConnection();
  </script>
</body>
</html>
